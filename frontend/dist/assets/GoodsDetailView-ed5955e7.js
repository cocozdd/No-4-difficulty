import{d as Oe,y as Fe,u as ze,z as We,v as Qe,A as Ye,a as g,b as je,c as f,o as Je,E as r,w as M,e as m,f as _,h as a,i as o,l as G,n as p,g as i,m as R,t as y,p as b,B as ue,F as ce,j as D,C as pe,k as He,D as Ke,G as $e,H as Xe,I as Ze,J as et,x as tt,q as at,s as st,_ as lt}from"./index-1ba1cfa6.js";import{u as ot,r as nt}from"./goodsStore-a546335a.js";import{u as it}from"./orderStore-69d556d9.js";import{g as rt}from"./image-d30f5149.js";const dt=N=>(at("data-v-dfa24573"),N=N(),st(),N),ut={key:0,class:"detail-view"},ct=["src"],pt={class:"detail-content"},vt={class:"title-row"},mt={class:"price"},gt={class:"stock"},ft={class:"seller-card"},_t={class:"owner-actions"},ht={key:1,class:"actions"},yt={key:0,class:"cart-actions"},bt=dt(()=>i("span",null,"Quantity",-1)),wt={class:"primary-actions"},It={class:"upload-row"},Ct={class:"dialog-footer"},kt={class:"chat-drawer"},Vt={key:0,class:"chat-status"},Et={key:1,class:"chat-status chat-status--offline"},Dt={key:0,class:"chat-empty"},Pt={class:"chat-meta"},Rt={class:"nickname"},St={class:"timestamp"},Ut={class:"chat-content-row"},Tt={key:0,class:"chat-unread-dot"},qt={key:1,class:"chat-bubble chat-bubble-image"},xt={key:2,class:"chat-bubble"},At={class:"chat-input"},Mt={class:"chat-input-actions"},ve=5*1024*1024,Gt=Oe({__name:"GoodsDetailView",setup(N){const B=Fe(),S=ze(),L=ot(),me=it(),w=We(),C=Qe(),X=Ye(),O=g(!1),U=g(!1),j=g(!1),J=g(!1),F=g(!1),H=g(),d=je({price:0,description:"",quantity:1,coverImageUrl:""}),ge={price:[{required:!0,message:"Price is required",trigger:"change"}],quantity:[{required:!0,message:"Quantity is required",trigger:"change"}],description:[{required:!0,message:"Description is required",trigger:"blur"}]},T=g(!1),v=g(null),z=g(""),k=g(""),W=g(null),q=g(!1),V=g(1),Q=g(!1),x=Number(B.params.id),s=f(()=>L.selectedGoods),Z=f(()=>C.userId??0),ee=f(()=>s.value&&C.userId===s.value.sellerId),E=f(()=>{var l,c;const e=((l=s.value)==null?void 0:l.sold)??!1,t=((c=s.value)==null?void 0:c.quantity)??0;return e||t<=0}),A=f(()=>{var e;return((e=s.value)==null?void 0:e.status)??"PENDING_REVIEW"}),fe=f(()=>A.value==="PENDING_REVIEW"),_e=f(()=>A.value==="REJECTED"),he={PENDING_REVIEW:"Pending Review",APPROVED:"Approved",REJECTED:"Rejected"},ye={PENDING_REVIEW:"warning",APPROVED:"success",REJECTED:"danger"},be=f(()=>he[A.value]),we=f(()=>ye[A.value]),K=f(()=>{var e;return((e=s.value)==null?void 0:e.quantity)??0}),te=f(()=>!C.isAuthenticated||ee.value||!s.value||A.value!=="APPROVED"?!1:K.value>0&&!E.value),ae=f(()=>E.value?{type:"warning",message:"This item has been sold and can no longer be modified or deleted."}:fe.value?{type:"warning",message:"Listing is awaiting admin review. Buyers cannot see it yet."}:_e.value?{type:"error",message:"Listing was rejected. Update the details and resubmit for review."}:{type:"success",message:"Listing is live. You can update or remove it here."}),$=f(()=>v.value==null?[]:w.conversationFor(v.value)),se=e=>{if(!e)return e;try{const t=new URL(e,window.location.origin);return t.hostname==="localhost"&&t.port==="9000"&&(t.protocol==="https:"||!t.protocol)&&(t.protocol="http:"),t.toString()}catch{return e.startsWith("//localhost:9000")?`http:${e}`:e.startsWith("https://localhost:9000")?e.replace("https://","http://"):e}},le=f(()=>!!k.value.trim()&&v.value!=null),Ie=e=>ue(e),P=()=>{Xe(()=>{W.value&&(W.value.scrollTop=W.value.scrollHeight)})};Je(()=>{L.loadGoodsById(x).then(()=>{nt(x).catch(()=>{})}).catch(()=>{r.error("Failed to load item details")})}),M(K,e=>{if(e<=0){V.value=1;return}V.value>e&&(V.value=e)}),M(()=>{var e;return(e=s.value)==null?void 0:e.id},()=>{V.value=1});const Ce=async()=>{var e,t;if(s.value){if(!C.isAuthenticated){S.push({name:"login",query:{redirect:B.fullPath}});return}if(te.value){Q.value=!0;try{await X.addToCart({goodsId:s.value.id,quantity:V.value}),r.success("Added to cart"),X.loadCart().catch(()=>{})}catch(l){const c=((t=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to add to cart";r.error(c)}finally{Q.value=!1}}}};M(s,e=>{e&&(d.price=e.price,d.description=e.description,d.quantity=e.quantity,d.coverImageUrl=e.coverImageUrl||"")},{immediate:!0}),M(()=>$.value.length,(e,t)=>{T.value&&e!==t&&(P(),v.value!=null&&w.markPartnerMessagesRead(v.value).catch(()=>{}))}),M(T,e=>{e?(P(),v.value!=null&&w.markPartnerMessagesRead(v.value).catch(()=>{})):k.value=""});const ke=async()=>{var e,t;if(!C.isAuthenticated){S.push({name:"login",query:{redirect:B.fullPath}});return}O.value=!0;try{await me.submitOrder({goodsId:x}),r.success("Order created. Continue from the Orders page."),S.push("/orders")}catch(l){const c=((t=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:t.message)||"Order creation failed";r.error(c)}finally{O.value=!1}},Ve=async()=>{if(s.value){if(!C.isAuthenticated){S.push({name:"login",query:{redirect:B.fullPath}});return}if(s.value.sellerId===C.userId){r.info("You are the seller of this listing.");return}v.value=s.value.sellerId,z.value=s.value.sellerNickname,T.value=!0,await w.refreshConversations().catch(()=>{}),await w.loadConversationMessages(s.value.sellerId),await w.markPartnerMessagesRead(s.value.sellerId).catch(()=>{}),P()}},oe=async()=>{if(!le.value||v.value==null)return;const e=k.value.trim();if(e)try{await w.sendMessage(v.value,e,"TEXT"),k.value="",P()}catch(t){const l=(t==null?void 0:t.message)||"Failed to send message";r.error(l)}},Ee=()=>!1,De=async e=>{const t=e.raw;if(t){if(!t.type.startsWith("image/")){r.error("Only image files are allowed");return}if(t.size>ve){r.error("Image size cannot exceed 5MB");return}if(v.value==null){r.warning("Open a chat before sending images");return}q.value=!0;try{await w.sendImageMessage(v.value,t),P()}catch(l){const c=(l==null?void 0:l.message)||"Failed to send image";r.error(c)}finally{q.value=!1}}},Pe=()=>{v.value=null,z.value="",k.value=""},Re=()=>!1,Se=async e=>{var l,c;const t=e.raw;if(t){if(!t.type.startsWith("image/")){r.error("Only image files are allowed");return}if(t.size>ve){r.error("Image size cannot exceed 5MB");return}F.value=!0;try{const{uploadGoodsImage:u}=await Ze(()=>import("./index-1ba1cfa6.js").then(I=>I.P),["assets/index-1ba1cfa6.js","assets/index-be303d94.css"]),{data:h}=await u(t);d.coverImageUrl=h.url,r.success("Image uploaded")}catch(u){const h=((c=(l=u==null?void 0:u.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to upload image";r.error(h)}finally{F.value=!1}}},Ue=()=>{d.coverImageUrl=""},Te=()=>{if(E.value){r.warning("Sold listings cannot be edited");return}s.value&&(U.value=!0)},qe=()=>{var e;s.value&&((e=H.value)==null||e.validate(async t=>{var l,c,u;if(t){j.value=!0;try{const I=(await L.updateGoods(x,{price:d.price,description:d.description,quantity:d.quantity,coverImageUrl:((l=d.coverImageUrl)==null?void 0:l.trim())||void 0})).status==="APPROVED"?"Listing updated":"Listing updated and resubmitted for review";r.success(I),U.value=!1}catch(h){const I=((u=(c=h==null?void 0:h.response)==null?void 0:c.data)==null?void 0:u.message)||"Failed to update listing";r.error(I)}finally{j.value=!1}}}))},xe=async()=>{var e,t;if(s.value){if(E.value){r.warning("Sold listings cannot be deleted");return}try{await et.confirm("Delete this listing? This action cannot be undone.","Confirm Deletion",{type:"warning",confirmButtonText:"Delete",cancelButtonText:"Cancel"})}catch{return}J.value=!0;try{await L.deleteGoods(x),r.success("Listing deleted"),S.push("/goods/mine")}catch(l){const c=((t=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to delete listing";r.error(c)}finally{J.value=!1}}},Ae=()=>{var e;(e=H.value)==null||e.clearValidate()};return(e,t)=>{const l=m("el-col"),c=m("el-tag"),u=m("el-button"),h=m("el-alert"),I=m("el-input-number"),Me=m("el-row"),Y=m("el-form-item"),ne=m("el-input"),ie=m("el-icon"),re=m("el-upload"),de=m("el-image"),Ge=m("el-form"),Ne=m("el-dialog"),Be=m("el-drawer"),Le=m("el-empty");return s.value?(p(),_("div",ut,[a(Me,{gutter:24},{default:o(()=>[a(l,{span:14},{default:o(()=>[i("img",{src:s.value.coverImageUrl||R(rt)(s.value.category),alt:"",class:"detail-cover"},null,8,ct)]),_:1}),a(l,{span:10},{default:o(()=>[i("div",pt,[i("div",vt,[i("h1",null,y(s.value.title),1),a(c,{type:we.value,size:"small"},{default:o(()=>[b(y(be.value),1)]),_:1},8,["type"])]),i("p",mt,"CNY "+y(s.value.price),1),i("p",gt,"Available: "+y(s.value.quantity),1),i("p",null,y(s.value.description),1),i("div",ft,[i("p",null,"Seller: "+y(s.value.sellerNickname),1),i("p",null,"Published: "+y(R(ue)(s.value.publishedAt)),1)]),ee.value?(p(),_(ce,{key:0},[i("div",_t,[a(u,{type:"primary",size:"large",onClick:Te,disabled:E.value},{default:o(()=>[b(" Edit Listing ")]),_:1},8,["disabled"]),a(u,{type:"danger",size:"large",loading:J.value,onClick:xe,disabled:E.value},{default:o(()=>[b(" Delete Listing ")]),_:1},8,["loading","disabled"])]),a(h,{title:ae.value.message,type:ae.value.type,"show-icon":"",closable:!1},null,8,["title","type"])],64)):E.value?(p(),G(h,{key:2,title:"This item has been sold and is no longer available.",type:"warning","show-icon":"",closable:!1})):(p(),_("div",ht,[te.value?(p(),_("div",yt,[bt,a(I,{modelValue:V.value,"onUpdate:modelValue":t[0]||(t[0]=n=>V.value=n),min:1,max:K.value,disabled:Q.value},null,8,["modelValue","max","disabled"]),a(u,{type:"primary",plain:"",size:"large",loading:Q.value,onClick:Ce},{default:o(()=>[b(" Add to Cart ")]),_:1},8,["loading"])])):D("",!0),i("div",wt,[a(u,{type:"primary",size:"large",onClick:ke,loading:O.value},{default:o(()=>[b(" Place Order ")]),_:1},8,["loading"]),a(u,{size:"large",onClick:Ve},{default:o(()=>[b(" Contact Seller ")]),_:1})])]))])]),_:1})]),_:1}),a(Ne,{modelValue:U.value,"onUpdate:modelValue":t[5]||(t[5]=n=>U.value=n),title:"Edit Listing",width:"520px",onClosed:Ae},{footer:o(()=>[i("span",Ct,[a(u,{onClick:t[4]||(t[4]=n=>U.value=!1)},{default:o(()=>[b("Cancel")]),_:1}),a(u,{type:"primary",loading:j.value,onClick:qe},{default:o(()=>[b("Save")]),_:1},8,["loading"])])]),default:o(()=>[a(Ge,{ref_key:"editFormRef",ref:H,model:d,rules:ge,"label-position":"top"},{default:o(()=>[a(Y,{label:"Price (CNY)",prop:"price"},{default:o(()=>[a(I,{modelValue:d.price,"onUpdate:modelValue":t[1]||(t[1]=n=>d.price=n),min:.01,step:1},null,8,["modelValue"])]),_:1}),a(Y,{label:"Quantity",prop:"quantity"},{default:o(()=>[a(I,{modelValue:d.quantity,"onUpdate:modelValue":t[2]||(t[2]=n=>d.quantity=n),min:1,step:1},null,8,["modelValue"])]),_:1}),a(Y,{label:"Description",prop:"description"},{default:o(()=>[a(ne,{modelValue:d.description,"onUpdate:modelValue":t[3]||(t[3]=n=>d.description=n),type:"textarea",rows:4},null,8,["modelValue"])]),_:1}),a(Y,{label:"Cover Image"},{default:o(()=>[i("div",It,[a(re,{class:"cover-upload","show-file-list":!1,"auto-upload":!1,accept:"image/*","before-upload":Re,"on-change":Se,disabled:F.value},{default:o(()=>[a(u,{type:"primary",loading:F.value},{icon:o(()=>[a(ie,null,{default:o(()=>[a(R(pe))]),_:1})]),default:o(()=>[b(" Upload Image ")]),_:1},8,["loading"])]),_:1},8,["disabled"]),d.coverImageUrl?(p(),G(de,{key:0,src:d.coverImageUrl,fit:"cover",class:"cover-preview"},null,8,["src"])):D("",!0),d.coverImageUrl?(p(),G(u,{key:1,text:"",type:"danger",onClick:Ue},{default:o(()=>[b(" Remove ")]),_:1})):D("",!0)])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(Be,{modelValue:T.value,"onUpdate:modelValue":t[7]||(t[7]=n=>T.value=n),title:`Chat with ${z.value||"Seller"}`,size:"30%","append-to-body":"",onClose:Pe},{default:o(()=>[i("div",kt,[R(w).connecting?(p(),_("div",Vt,"Connecting...")):R(w).connected?D("",!0):(p(),_("div",Et," Not connected. Messages will appear once the chat service reconnects. ")),i("div",{class:"chat-body",ref_key:"chatBodyRef",ref:W},[$.value.length?D("",!0):(p(),_("div",Dt," Start a conversation with "+y(z.value||"the seller")+". ",1)),(p(!0),_(ce,null,He($.value,n=>(p(),_("div",{key:n.id,class:Ke(["chat-message",{outgoing:n.senderId===Z.value}])},[i("div",Pt,[i("span",Rt,y(n.senderId===Z.value?"You":n.senderNickname),1),i("span",St,y(Ie(n.timestamp)),1)]),i("div",Ut,[n.senderId===v.value&&!n.read?(p(),_("span",Tt)):D("",!0),n.type==="IMAGE"?(p(),_("div",qt,[a(de,{src:se(n.content),fit:"cover","preview-src-list":[se(n.content)],onLoad:P},null,8,["src","preview-src-list"])])):(p(),_("div",xt,y(n.content),1))])],2))),128))],512),i("div",At,[a(ne,{modelValue:k.value,"onUpdate:modelValue":t[6]||(t[6]=n=>k.value=n),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"Type a message",onKeyup:$e(tt(oe,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeyup"]),i("div",Mt,[v.value?(p(),G(re,{key:0,class:"chat-upload","show-file-list":!1,"auto-upload":!1,accept:"image/*","before-upload":Ee,"on-change":De,disabled:q.value},{default:o(()=>[a(u,{text:"",type:"primary",disabled:q.value,loading:q.value},{default:o(()=>[a(ie,null,{default:o(()=>[a(R(pe))]),_:1})]),_:1},8,["disabled","loading"])]),_:1},8,["disabled"])):D("",!0),a(u,{type:"primary",loading:O.value,onClick:oe,disabled:!le.value},{default:o(()=>[b(" Send ")]),_:1},8,["loading","disabled"])])])])]),_:1},8,["modelValue","title"])])):(p(),G(Le,{key:1,description:"Item not found"}))}}});const Ft=lt(Gt,[["__scopeId","data-v-dfa24573"]]);export{Ft as default};
