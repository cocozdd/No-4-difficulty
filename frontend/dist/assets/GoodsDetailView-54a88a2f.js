import{d as se,s as oe,u as le,l as ie,v as h,m as ne,c as u,o as re,E as d,x as de,r as n,a as S,e as a,w as o,j as U,f,b as r,k as O,t as y,g as _,q as ce,F as ue,y as pe,_ as me}from"./index-bb0676e0.js";import{u as ge}from"./goodsStore-dad07cae.js";import{u as _e}from"./orderStore-b6edc29a.js";import{f as ve}from"./date-4ca18749.js";import{g as fe}from"./image-d30f5149.js";const ye={key:0,class:"detail-view"},be=["src"],we={class:"detail-content"},he={class:"title-row"},Ee={class:"price"},Ve={class:"seller-card"},Ce={class:"owner-actions"},De={key:1,class:"actions"},Ie={class:"dialog-footer"},ke=se({__name:"GoodsDetailView",setup(Re){const L=oe(),D=le(),E=ge(),B=_e(),T=ie(),I=h(!1),b=h(!1),k=h(!1),R=h(!1),P=h(),l=ne({price:0,description:"",coverImageUrl:""}),F={price:[{required:!0,message:"Price is required",trigger:"change"}],description:[{required:!0,message:"Description is required",trigger:"blur"}]},V=Number(L.params.id),s=u(()=>E.selectedGoods),A=u(()=>s.value&&T.userId===s.value.sellerId),v=u(()=>{var e;return((e=s.value)==null?void 0:e.sold)??!1}),C=u(()=>{var e;return((e=s.value)==null?void 0:e.status)??"PENDING_REVIEW"}),q=u(()=>C.value==="PENDING_REVIEW"),z=u(()=>C.value==="REJECTED"),M={PENDING_REVIEW:"Pending Review",APPROVED:"Approved",REJECTED:"Rejected"},W={PENDING_REVIEW:"warning",APPROVED:"success",REJECTED:"danger"},x=u(()=>v.value?{type:"warning",message:"This item has been sold and can no longer be modified or deleted."}:q.value?{type:"warning",message:"Listing is awaiting admin review. Buyers cannot see it yet."}:z.value?{type:"error",message:"Listing was rejected. Update the details and resubmit for review."}:{type:"success",message:"Listing is live. You can update or remove it here."}),j=u(()=>M[C.value]),J=u(()=>W[C.value]);re(()=>{E.loadGoodsById(V).catch(()=>{d.error("Failed to load item details")})}),de(s,e=>{e&&(l.price=e.price,l.description=e.description,l.coverImageUrl=e.coverImageUrl||"")},{immediate:!0});const Y=async()=>{var e,t;if(!T.isAuthenticated){D.push({name:"login",query:{redirect:L.fullPath}});return}I.value=!0;try{await B.submitOrder({goodsId:V}),d.success("Order created. Continue the flow from the Orders page."),D.push("/orders")}catch(i){const p=((t=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:t.message)||"Order creation failed";d.error(p)}finally{I.value=!1}},$=()=>{d.info("Chat will be available after the WebSocket module is integrated")},H=()=>{if(v.value){d.warning("Sold listings cannot be edited");return}s.value&&(b.value=!0)},K=()=>{var e;s.value&&((e=P.value)==null||e.validate(async t=>{var i,p,c;if(t){k.value=!0;try{const w=(await E.updateGoods(V,{price:l.price,description:l.description,coverImageUrl:((i=l.coverImageUrl)==null?void 0:i.trim())||void 0})).status==="APPROVED"?"Listing updated":"Listing updated and resubmitted for review";d.success(w),b.value=!1}catch(g){const w=((c=(p=g==null?void 0:g.response)==null?void 0:p.data)==null?void 0:c.message)||"Failed to update listing";d.error(w)}finally{k.value=!1}}}))},Q=async()=>{var e,t;if(s.value){if(v.value){d.warning("Sold listings cannot be deleted");return}try{await pe.confirm("Delete this listing? This action cannot be undone.","Confirm Deletion",{type:"warning",confirmButtonText:"Delete",cancelButtonText:"Cancel"})}catch{return}R.value=!0;try{await E.deleteGoods(V),d.success("Listing deleted"),D.push("/goods/mine")}catch(i){const p=((t=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to delete listing";d.error(p)}finally{R.value=!1}}},X=()=>{var e;(e=P.value)==null||e.clearValidate()};return(e,t)=>{const i=n("el-col"),p=n("el-tag"),c=n("el-button"),g=n("el-alert"),w=n("el-row"),Z=n("el-input-number"),N=n("el-form-item"),G=n("el-input"),ee=n("el-form"),te=n("el-dialog"),ae=n("el-empty");return s.value?(f(),S("div",ye,[a(w,{gutter:24},{default:o(()=>[a(i,{span:14},{default:o(()=>[r("img",{src:s.value.coverImageUrl||O(fe)(s.value.category),alt:"",class:"detail-cover"},null,8,be)]),_:1}),a(i,{span:10},{default:o(()=>[r("div",we,[r("div",he,[r("h1",null,y(s.value.title),1),s.value?(f(),U(p,{key:0,type:J.value,size:"small"},{default:o(()=>[_(y(j.value),1)]),_:1},8,["type"])):ce("",!0)]),r("p",Ee,"CNY "+y(s.value.price),1),r("p",null,y(s.value.description),1),r("div",Ve,[r("p",null,"Seller: "+y(s.value.sellerNickname),1),r("p",null,"Published: "+y(O(ve)(s.value.publishedAt)),1)]),A.value?(f(),S(ue,{key:0},[r("div",Ce,[a(c,{type:"primary",size:"large",onClick:H,disabled:v.value},{default:o(()=>[_(" Edit Listing ")]),_:1},8,["disabled"]),a(c,{type:"danger",size:"large",loading:R.value,onClick:Q,disabled:v.value},{default:o(()=>[_(" Delete Listing ")]),_:1},8,["loading","disabled"])]),a(g,{title:x.value.message,type:x.value.type,"show-icon":"",closable:!1},null,8,["title","type"])],64)):v.value?(f(),U(g,{key:2,title:"This item has been sold and is no longer available.",type:"warning","show-icon":"",closable:!1})):(f(),S("div",De,[a(c,{type:"primary",size:"large",onClick:Y,loading:I.value},{default:o(()=>[_(" Place Order ")]),_:1},8,["loading"]),a(c,{size:"large",onClick:$,disabled:""},{default:o(()=>[_("Contact Seller (coming soon)")]),_:1})]))])]),_:1})]),_:1}),a(te,{modelValue:b.value,"onUpdate:modelValue":t[4]||(t[4]=m=>b.value=m),title:"Edit Listing",width:"480px",onClosed:X},{footer:o(()=>[r("span",Ie,[a(c,{onClick:t[3]||(t[3]=m=>b.value=!1)},{default:o(()=>[_("Cancel")]),_:1}),a(c,{type:"primary",loading:k.value,onClick:K},{default:o(()=>[_("Save")]),_:1},8,["loading"])])]),default:o(()=>[a(ee,{ref_key:"editFormRef",ref:P,model:l,rules:F,"label-position":"top"},{default:o(()=>[a(N,{label:"Price (CNY)",prop:"price"},{default:o(()=>[a(Z,{modelValue:l.price,"onUpdate:modelValue":t[0]||(t[0]=m=>l.price=m),min:.01,step:1},null,8,["modelValue"])]),_:1}),a(N,{label:"Description",prop:"description"},{default:o(()=>[a(G,{modelValue:l.description,"onUpdate:modelValue":t[1]||(t[1]=m=>l.description=m),type:"textarea",rows:4},null,8,["modelValue"])]),_:1}),a(N,{label:"Cover Image URL"},{default:o(()=>[a(G,{modelValue:l.coverImageUrl,"onUpdate:modelValue":t[2]||(t[2]=m=>l.coverImageUrl=m),placeholder:"Leave empty to keep existing"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])):(f(),U(ae,{key:1,description:"Item not found"}))}}});const Te=me(ke,[["__scopeId","data-v-4c31f568"]]);export{Te as default};
