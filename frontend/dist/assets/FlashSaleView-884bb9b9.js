import{r as x,d as ae,u as se,v as le,c as B,a as f,o as ne,O as oe,E as g,b as re,e as d,f as k,l as T,i as n,j as U,h as a,n as _,g as o,p as h,F as ie,k as ce,D as de,t as m,q as ue,s as me,J as pe,_ as _e}from"./index-1ba1cfa6.js";const fe=p=>x.post("/flash-sale/items",p),ge=()=>x.get("/flash-sale/items"),he=p=>x.post("/flash-sale/purchase",{flashSaleItemId:p}),M=p=>(ue("data-v-a73d1fbe"),p=p(),me(),p),ve={class:"flash-sale-view"},ye=M(()=>o("section",{class:"page-header"},[o("h1",null,"Flash Sale 秒杀专区"),o("p",null,"限时限量，手快有，手慢无。")],-1)),we={class:"card-header"},ke=M(()=>o("span",null,"创建秒杀活动",-1)),Te={class:"card-header"},De=M(()=>o("span",null,"进行中 / 即将开始的活动",-1)),be={class:"sale-card__header"},Ne={key:0,class:"sale-desc"},Ve={class:"sale-card__body"},Se={class:"price-block"},Ie={class:"flash-price"},Pe={class:"original-price"},Ue={class:"meta-block"},xe={key:0,class:"countdown"},Me={class:"sale-card__footer"},Ye=ae({__name:"FlashSaleView",setup(p){const G=se(),Y=le(),z=B(()=>Y.role==="ADMIN"),C=B(()=>Y.isAuthenticated),E=f(Date.now());let D=null;ne(()=>{y(),D=window.setInterval(()=>{E.value=Date.now()},1e3)}),oe(()=>{D&&clearInterval(D)});const b=f([]),N=f(!1),V=f(null),y=async()=>{N.value=!0;try{const{data:s}=await ge();b.value=s}catch{g.error("加载秒杀活动失败")}finally{N.value=!1}},F=()=>({title:"",description:"",originalPrice:null,flashPrice:null,totalStock:null,startTime:null,endTime:null}),l=re(F()),S=f(),I=f(!1),j={title:[{required:!0,message:"请输入标题",trigger:"blur"}],originalPrice:[{required:!0,message:"请输入原价",trigger:"change"}],flashPrice:[{required:!0,message:"请输入秒杀价",trigger:"change"}],totalStock:[{required:!0,message:"请输入库存",trigger:"change"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"}]},H=()=>{Object.assign(l,F())},A=async()=>{S.value&&await S.value.validate(async s=>{var t,c;if(s){if(!l.startTime||!l.endTime){g.warning("请选择开始和结束时间");return}if(new Date(l.endTime)<=new Date(l.startTime)){g.warning("结束时间必须晚于开始时间");return}I.value=!0;try{await fe({title:l.title,description:l.description,originalPrice:Number(l.originalPrice),flashPrice:Number(l.flashPrice),totalStock:Number(l.totalStock),startTime:l.startTime,endTime:l.endTime}),g.success("已发布秒杀活动"),H(),y()}catch(r){const i=((c=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:c.message)??"创建秒杀活动失败";g.error(i)}finally{I.value=!1}}})},O=s=>!C.value||s.status!=="RUNNING"?!1:s.remainingStock>0,J=async s=>{var t,c;if(!C.value){G.push({name:"login",query:{redirect:"/flash-sale"}});return}V.value=s.id;try{const{data:r}=await he(s.id);g.success(`抢购成功，订单号：${r.orderId}`),await y()}catch(r){const i=((c=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:c.message)??"抢购失败，请稍后重试";pe.alert(i,"抢购结果",{type:"warning"})}finally{V.value=null}},K=s=>{switch(s){case"RUNNING":return"success";case"SCHEDULED":return"warning";default:return"info"}},Q=s=>{switch(s){case"RUNNING":return"进行中";case"SCHEDULED":return"未开始";default:return"已结束"}},W=s=>({"is-running":s.status==="RUNNING","is-ended":s.status==="ENDED"}),q=s=>{const t=new Date(s);return Number.isNaN(t.getTime())?s:t.toLocaleString()},X=s=>{const t=new Date(s.startTime).getTime(),c=new Date(s.endTime).getTime(),r=E.value;return s.status==="SCHEDULED"?`距离开始还有 ${L(t-r)}`:s.status==="RUNNING"?`距离结束还有 ${L(c-r)}`:"活动已结束"},L=s=>{if(s<=0)return"0秒";const t=Math.floor(s/1e3),c=Math.floor(t/86400),r=Math.floor(t%86400/3600),i=Math.floor(t%3600/60),v=t%60,u=[];return c&&u.push(`${c}天`),r&&u.push(`${r}小时`),i&&u.push(`${i}分钟`),u.push(`${v}秒`),u.join("")};return(s,t)=>{const c=d("el-tag"),r=d("el-input"),i=d("el-form-item"),v=d("el-input-number"),u=d("el-col"),R=d("el-row"),$=d("el-date-picker"),w=d("el-button"),Z=d("el-form"),P=d("el-card"),ee=d("el-empty"),te=d("el-space");return _(),k("div",ve,[ye,z.value?(_(),T(P,{key:0,shadow:"never",class:"create-card"},{header:n(()=>[o("div",we,[ke,a(c,{type:"warning",size:"small"},{default:n(()=>[h("管理员")]),_:1})])]),default:n(()=>[a(Z,{model:l,rules:j,ref_key:"formRef",ref:S,"label-width":"100px",size:"small"},{default:n(()=>[a(i,{label:"标题",prop:"title"},{default:n(()=>[a(r,{modelValue:l.title,"onUpdate:modelValue":t[0]||(t[0]=e=>l.title=e),placeholder:"活动标题，例如：限量耳机秒杀"},null,8,["modelValue"])]),_:1}),a(i,{label:"描述"},{default:n(()=>[a(r,{modelValue:l.description,"onUpdate:modelValue":t[1]||(t[1]=e=>l.description=e),type:"textarea",placeholder:"活动亮点/规则说明"},null,8,["modelValue"])]),_:1}),a(R,{gutter:16},{default:n(()=>[a(u,{xs:24,md:12},{default:n(()=>[a(i,{label:"原价",prop:"originalPrice"},{default:n(()=>[a(v,{modelValue:l.originalPrice,"onUpdate:modelValue":t[2]||(t[2]=e=>l.originalPrice=e),min:0,precision:2},null,8,["modelValue"])]),_:1})]),_:1}),a(u,{xs:24,md:12},{default:n(()=>[a(i,{label:"秒杀价",prop:"flashPrice"},{default:n(()=>[a(v,{modelValue:l.flashPrice,"onUpdate:modelValue":t[3]||(t[3]=e=>l.flashPrice=e),min:0,precision:2},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(i,{label:"库存",prop:"totalStock"},{default:n(()=>[a(v,{modelValue:l.totalStock,"onUpdate:modelValue":t[4]||(t[4]=e=>l.totalStock=e),min:1},null,8,["modelValue"])]),_:1}),a(R,{gutter:16},{default:n(()=>[a(u,{xs:24,md:12},{default:n(()=>[a(i,{label:"开始时间",prop:"startTime"},{default:n(()=>[a($,{modelValue:l.startTime,"onUpdate:modelValue":t[5]||(t[5]=e=>l.startTime=e),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DDTHH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1}),a(u,{xs:24,md:12},{default:n(()=>[a(i,{label:"结束时间",prop:"endTime"},{default:n(()=>[a($,{modelValue:l.endTime,"onUpdate:modelValue":t[6]||(t[6]=e=>l.endTime=e),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DDTHH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(i,null,{default:n(()=>[a(w,{type:"primary",loading:I.value,onClick:A},{default:n(()=>[h(" 发布秒杀 ")]),_:1},8,["loading"]),a(w,{onClick:H},{default:n(()=>[h("重置")]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})):U("",!0),a(P,{shadow:"never"},{header:n(()=>[o("div",Te,[De,a(w,{type:"primary",link:"",onClick:y,loading:N.value},{default:n(()=>[h(" 刷新 ")]),_:1},8,["loading"])])]),default:n(()=>[b.value.length?(_(),T(te,{key:1,direction:"vertical",size:16,wrap:"",style:{width:"100%"}},{default:n(()=>[(_(!0),k(ie,null,ce(b.value,e=>(_(),T(P,{key:e.id,class:de(["sale-card",W(e)])},{default:n(()=>[o("div",be,[o("div",null,[o("h3",null,m(e.title),1),e.description?(_(),k("p",Ne,m(e.description),1)):U("",!0)]),a(c,{type:K(e.status)},{default:n(()=>[h(m(Q(e.status)),1)]),_:2},1032,["type"])]),o("div",Ve,[o("div",Se,[o("span",Ie,"¥ "+m(e.flashPrice.toFixed(2)),1),o("span",Pe,"原价 ¥ "+m(e.originalPrice.toFixed(2)),1)]),o("div",Ue,[o("span",null,"库存："+m(e.remainingStock)+" / "+m(e.totalStock),1),o("span",null,"开始："+m(q(e.startTime)),1),o("span",null,"结束："+m(q(e.endTime)),1)]),e.status!=="ENDED"?(_(),k("p",xe,m(X(e)),1)):U("",!0)]),o("div",Me,[a(w,{type:"primary",disabled:!O(e),loading:V.value===e.id,onClick:Ce=>J(e)},{default:n(()=>[h(" 马上抢购 ")]),_:2},1032,["disabled","loading","onClick"])])]),_:2},1032,["class"]))),128))]),_:1})):(_(),T(ee,{key:0,description:"暂时没有秒杀活动"}))]),_:1})])}}});const Fe=_e(Ye,[["__scopeId","data-v-a73d1fbe"]]);export{Fe as default};
